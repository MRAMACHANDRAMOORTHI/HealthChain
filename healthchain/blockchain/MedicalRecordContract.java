package msr.healthchain.blockchain;

import java.math.BigInteger;
import java.util.Arrays;
import java.util.Collections;
import org.web3j.abi.TypeReference;
import org.web3j.abi.datatypes.Function;
import org.web3j.abi.datatypes.Type;
import org.web3j.abi.datatypes.Utf8String;
import org.web3j.crypto.Credentials;
import org.web3j.protocol.Web3j;
import org.web3j.protocol.core.RemoteCall;
import org.web3j.protocol.core.methods.response.TransactionReceipt;
import org.web3j.tx.Contract;
import org.web3j.tx.gas.ContractGasProvider;

public class MedicalRecordContract extends Contract {
    // From MedicalRecord.bin
    private static final String BINARY = "0x60806040523480156100115760006000fd5b50610017565b610601806100266000396000f3fe60806040523480156100115760006000fd5b506004361061003b5760003560e01c80633304523514610041578063cc368d531461005d5761003b565b60006000fd5b61005b60048036038101906100569190610337565b61008d565b005b610077600480360381019061007291906102f3565b610118565b604051610084919061042c565b60405180910390f35b806000600050836040516100a19190610414565b908152602001604051809103902060005090805190602001906100c59291906101d3565b50816040516100d49190610414565b60405180910390207f37e56abd6300db1b1b6aaaafb047345578f323e7f727f5c5b9f9a28a54962105a8260405161010b919061042c565b60405180910390a25b5050565b606060006000508260405161012d9190610414565b9081526020016040518091039020600050805461014990610521565b80601f016020809104026020016040519081016040528092919081815260200182805461017590610521565b80156101c25780601f10610197576101008083540402835291602001916101c2565b820191906000526020600020905b8154815290600101906020018083116101a557829003601f168201915b505050505090506101ce565b919050565b8280546101df90610521565b90600052602060002090601f016020900481019282610201576000855561024d565b82601f1061021a57805160ff191683800117855561024d565b8280016001018555821561024d579182015b8281111561024c57825182559160200191906001019061022c565b5b50905061025a919061025e565b5090565b5b8082111561027d576000816000905550600101610263565b5090565b600061029861029384610481565b61044f565b9050828152602081018484840111156102b15760006000fd5b6102bc8482856104dc565b509392505050565b600082601f8301126102d25760006000fd5b81356102e2848260208601610285565b91505092915050565b6000602082840312156102fe5760006000fd5b600082013567ffffffffffffffff8111156103195760006000fd5b610325848285016102c5565b91505092915050565b6000604082840312156103415760006000fd5b81905092915050565b60006040828403121561035d5760006000fd5b600061036b848285016102c5565b91505092915050565b600061037f826104b2565b61038981856104be565b93506103998185602086016104ec565b6103a2816105b8565b840191505092915050565b60006103b8826104b2565b6103c281856104d0565b93506103d28185602086016104ec565b80840191505092915050565b60006103e982846103ad565b915081905092915050565b600061040082846103b3565b915081905092915050565b600060208201905081810360008301526104248184610374565b905092915050565b6000602082019050818103600083015261044581846103a8565b905092915050565b6000604051905081810167ffffffffffffffff8111828210171561047357610472610587565b5b8060405250919050565b600067ffffffffffffffff82111561049857610497610587565b5b602082029050602081019050919050565b600081519050919050565b600082825260208201905092915050565b600081905092915050565b600082825260208201905092915050565b82818337505050565b6000601f19601f8301169050919050565b60005b838110156105165780820151818401526020810190506104fb565b83811115610525576000848401525b50505050565b6000600282049050600182168061054257607f821691505b6020821081141561055657610555610558565b5b50919050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052602260045260246000fd5b7f4e487b7100000000000000000000000000000000000000000000000000000000600052604160045260246000fd5b6000601f19601f8301169050919050565bfea2646970667358221220fab90e227efef67c6f936a31b719c274cc64ce11608202c6c729d455820abd7164736f6c63430008000033";

    public static final String FUNC_STOREMEDICALRECORD = "storeMedicalRecord";
    public static final String FUNC_GETMEDICALRECORD = "getMedicalRecord";

    protected MedicalRecordContract(String contractAddress, Web3j web3j, Credentials credentials, ContractGasProvider contractGasProvider) {
        super(BINARY, contractAddress, web3j, credentials, contractGasProvider);
    }

    public RemoteCall<TransactionReceipt> storeMedicalRecord(String patientId, String encryptedData) {
        final Function function = new Function(
                FUNC_STOREMEDICALRECORD,
                Arrays.asList(new Utf8String(patientId), new Utf8String(encryptedData)),
                Collections.emptyList()
        );
        return executeRemoteCallTransaction(function);
    }

    public RemoteCall<String> getMedicalRecord(String patientId) {
        final Function function = new Function(
                FUNC_GETMEDICALRECORD,
                Arrays.asList(new Utf8String(patientId)),
                Arrays.asList(new TypeReference<Utf8String>() {})
        );
        return executeRemoteCallSingleValueReturn(function, String.class);
    }

    public static MedicalRecordContract load(String contractAddress, Web3j web3j, Credentials credentials, ContractGasProvider contractGasProvider) {
        return new MedicalRecordContract(contractAddress, web3j, credentials, contractGasProvider);
    }
}
